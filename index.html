<!DOCTYPE html>
<html>
    <head>
        <title>LanGo</title>
        <link rel="icon" type="image/x-icon" href="favicon.ico">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
        <script
                src="https://code.jquery.com/jquery-3.5.1.js"
                integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
                crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

        <link rel="stylesheet" href="style.css">

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-HCDVECSH1D"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-HCDVECSH1D');
        </script>
    </head>
    <body>
    <br/>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="centered">LanGo</h1>
                <br>
                <div class="progress">
                  <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width:0%"></div>
                </div>
                <br>
                <div id="dots" class="centered" data-toggle="tooltip"  onclick="copyDivToClipboard()"></div>
                <h2 id="all-done" style="display: none;">All done for today!</h2>
                <h2 id="word" class="word centered"></h2>
                <h2 class="centered next" style="display: none;"><a href='#' >Next</a></h2>
                <br>            
                <div class="row" id="languages">
  
                </div>
            <br >
            <!-- <h2 class="centered next" style="display: none;"><a href='#'>Next</a></h2> -->
            </div>
        </div>
    </div>
    <script type="text/javascript" src="data/game.js"></script>

    <script>
        function copyDivToClipboard() {
            var range = document.createRange();
            range.selectNode(document.getElementById("dots"));
            window.getSelection().removeAllRanges(); // clear current selection
            window.getSelection().addRange(range); // to select text
            document.execCommand("copy");
            window.getSelection().removeAllRanges();// to deselect
        }

        var DOTS = ['ðŸŸ¢', 'ðŸŸ¡', 'ðŸ”´', 'âš«'];
        function get_score(games, GAME){
            var score = '';
            games.forEach((game, i) => {
                if (game.length){
                    if (game.includes(GAME['games'][i][1]))
                        score += DOTS[game.length-1];
                    else
                        score += DOTS[DOTS.length-1];
                }
            });
            return score;
        }

        $(document).ready(function(){  

            // localStorage.clear();
            if ((!'games' in localStorage) || localStorage['id'] != GAME['id']){
                localStorage['games'] = JSON.stringify([[]]);
                localStorage['id'] = GAME['id'];
            }

            var games = JSON.parse(localStorage['games']);
            var current_game_id = games.length-1;
            var current_game = games[current_game_id];

            if (current_game_id >= GAME['games'].length){
                // finished
                $('#all-done').show();
                $('#dots').html(get_score(games, GAME));
                $('#dots').attr('title', 'Click to copy!');
                $('[data-toggle="tooltip"]').tooltip({placement: 'top',trigger: 'manual'}).tooltip('show'); 

                var progress = parseInt((games.length-1) / GAME['games'].length * 100);
                $(".progress-bar").css("width", progress + "%");
                $(".progress-bar").addClass('bg-success');
            } 
            else {
                var word = GAME['games'][current_game_id][0];
                var true_language = GAME['games'][current_game_id][1];
                

                var finished = false;

                $('#word').html(word);
                var languages_html = ''
                GAME['languages'].forEach(language => {
                    languages_html += '<div class="col-6 col-sm-4 col-md-4 col-lg-3 col-xl-2">';
                    languages_html += '<div id="' + language + '" class="lang centered">' + language + '</div>';
                    languages_html += '</div>';
                });
                $('#languages').html(languages_html);

        

                var progress = parseInt((games.length-1) / GAME['games'].length * 100);
                console.log(progress);  
                $(".progress-bar").css("width", progress + "%");
                    


                $('#dots').html(get_score(games, GAME));
                if (current_game.length >= 3){
                    $('#'+true_language).addClass('alert alert-secondary');
                    finished = true;
                    $('.next').show();
                }
                current_game.forEach(guess => {
                    if (guess == true_language){
                        $('#'+guess).addClass('alert alert-success');
                        finished = true;
                        $('.next').show();
                    }
                    else
                        $('#'+guess).addClass('alert alert-danger');

                });

                $('.lang').click(function(){
                    if (!finished){
                        var button = $(this);
                        var lang = button.html();
                        if (!current_game.includes(lang))
                            current_game.push(lang);
                        localStorage['games'] = JSON.stringify(games);    
                        if (lang == true_language){
                            button.addClass('alert alert-success');
                            $('.next').show();
                            finished = true;
                            $('#dots').html(get_score(games, GAME));
                        }
                        else {
                            if (current_game.length == 3){
                                finished = true;
                                $('.next').show();
                                $('#' + true_language).addClass('alert alert-secondary');
                                $('#dots').html(get_score(games, GAME));
                            }
                            button.addClass('alert alert-danger');
                        }
                    }
                });

                $('.next').click(function(){
                    games.push([]);
                    localStorage['games'] = JSON.stringify(games);    
                    window.location.href = "?";
                });
            }
        });
    </script>
    </body>
</html>